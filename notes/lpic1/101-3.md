# Change runlevels/boot Targets and Shutdown or Reboot system

## Runlevels and Boot Targets

Runlevels indicate that what tasks can be accomplished in the current state of a Linux
system. Think of it as stages of being alive.

### Systemd

On systemd we have targets that are group of services.

You can run `systemctl isolate {target}` to switch to the specified target.

| Target    | Description                                                       | Usage                                     |
| --------- | ----------------------------------------------------------------- | ----------------------------------------- |
| emergency | The most minimal rescue environment                               |                                           |
| rescue    | Local file systems are mounted, no networking, and root-user only | maintenance, recovery, and password reset |
| multiuser | Multi-user with networking                                        | Most common for servers                   |
| graphical | Multi-user + GUI                                                  | Default for desktop linus systems         |
| halt      | Stop all processes and stop CPU activity.                         | -                                         |
| poweroff  | Like halt but send an ACPI shutdown signal.                       | -                                         |
| reboot    | Reboot                                                            | -                                         |

#### Setting and Getting the Default Target

```bash
systemctl get-default
graphical.target

systemctl set-default multi-user.target
```

#### How Systemd work on the system's boot

1. Kernel loads and starts `/lib/systemd/system` or `/usr/lib/systemd/system` as the PID
   1\.
2. Systemd reads the default target at `/etc/systemd/system/default.target` (mine is at
   the `/lib/systemd/system/default.target`). Btw the files is just a link to the actual
   target file.
3. Systemd starts the units and run them in parallel until it reaches to the default
   target state.

### SysVinit

| Runlevel | Description                                                                          | Systemd Target |
| -------- | ------------------------------------------------------------------------------------ | -------------- |
| 0        | Shutdown or Halt                                                                     | poweroff/halt  |
| 1 or S   | Local file systems are mounted, no networking, and root-user only (maintenance mode) | rescue         |
| 2        | Multi-user with networking                                                           | -              |
| 3        | Multi-user with networking                                                           | multi-user     |
| 4        | Custom runlevel. You can customize it.                                               | -              |
| 5        | Multi-user + GUI                                                                     | graphical      |
| 6        | Reboot                                                                               | reboot         |

#### How SysVinit work on the system's boot

1. Kernel loads and starts the `/sbin/init` (PID 1).
2. The init process will read the configuration from `/etc/inittab` and determine the
   default runlevel.
3. Init execute the associated scripts for the default runlevel, placed in: `/etc/rc.d`.
4. The services start sequentially. One of the disadvantages of SysVinit that made it
   replaced by `systemd` is that it runs the services sequentially. `Systemd` will
   resolve the dependencies of units and run them in parallel, resulting in faster boot.

**/etc/rc.d/ scripts**:

```bash
cd rc
rc0.d/ rc1.d/ rc2.d/ rc3.d/ rc4.d/ rc5.d/ rc6.d/ rcS.d/
```

The numbers are related to their associated runlevel. when you run `init 0`, init will
run the scripts in `rc0.d/`.

```bash
root@ideapad:/etc# ls rc2.d/
K01apache-htcacheclean  S01acpid    S01apport   K01speech-dispatcher
```

The links starting with K mean Kill/Stop. The links starting with S means Start. The
numbers associated after S/K are determine the execution order of links.

> ðŸ’¡ The configuration of SysVinit is at `/etc/inittab`. This is the place that you can
> set the default runlevel.

**Commands**:

- runlevel -> Tell the current and previous runlevels.
- who -r -> Tell the current and previous runlevels + timestamp.
- telinit/init 5 -> Switch to the specified runlevel.

## Shutdown and Reboot the system

The preferred method for shutting down a Linux system is using the `shutdown` command.
The command can send a warning message to all the logged-in users working on the system,
and it prevents login any new users. It signals init to switch runlevels. Then it will
send SIGTERM signal to the current running processes, giving them a chance to terminate
properly and save data or cleanup properly before being killed. After one minute or
another delay it will send a SIGKILL signal to the processes to forcibly end each proc.

```bash
shutdown  # Shutdown the system after 1 minute.
shutdown -c  # Cancel the shutdown.
shutdown -r  # Reboot.
shutdown -h  # Halt.
shutdown -r +60 "Shutting down in an hour"
shutdown -r now  # Shutdown now!
shutdown -r 2:20  # Shutdown at 2:20 AM.
```

**Commands**:

- poweroff -> Halt the system and power it off immediately.
- halt -> Halt the system immediately.
- reboot -> Reboot the system immediately.

## Notifying Users

It is good to be informed especially when the system is going down. Tools and commands
for notifying:

- wall "Hey, we are going down."
- mesg -> Command for controlling wall messages for a user. `mesg n` will prevent walls
  to be shown. The shutdown wall doesn't respect this setting.
- `/etc/issue` and `/etc/issue.net` -> Legacy files for the text displayed on tty/remote
  login.
- `/etc/motd` -> Message of the day, the content that you see on login into a server.

## Advance Configuration and Power Interface

ACPI provides an open standard for operating systems to discover and configure hardware
components. This subsystem will help the operating system to signal the computer to
terminate power and electricity at the poweroff event.
